<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Linux的使用者中有很多人还无法纯熟的玩转iptables.网络不通,常会怀疑防火墙，但不能精确的诊断.给出依据.本文总结下iptables，整理下自己的思路.">
<meta name="keywords" content="iptables">
<meta property="og:type" content="article">
<meta property="og:title" content="玩转Linux防火墙命令iptables[转]">
<meta property="og:url" content="http://blog.kompaz.win/2017/07/05/（转）玩转Linux防火墙命令iptables/index.html">
<meta property="og:site_name" content="Kompass">
<meta property="og:description" content="Linux的使用者中有很多人还无法纯熟的玩转iptables.网络不通,常会怀疑防火墙，但不能精确的诊断.给出依据.本文总结下iptables，整理下自己的思路.">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://fishcried.com/img/netfilter_iptables.png">
<meta property="og:image" content="http://fishcried.com/img/netfilter_arch.png">
<meta property="og:image" content="http://fishcried.com/img/iptables_netfilter.png">
<meta property="og:image" content="http://fishcried.com/img/iptables_usage.png">
<meta property="og:updated_time" content="2018-05-08T01:52:32.854Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="玩转Linux防火墙命令iptables[转]">
<meta name="twitter:description" content="Linux的使用者中有很多人还无法纯熟的玩转iptables.网络不通,常会怀疑防火墙，但不能精确的诊断.给出依据.本文总结下iptables，整理下自己的思路.">
<meta name="twitter:image" content="http://fishcried.com/img/netfilter_iptables.png">






  <link rel="canonical" href="http://blog.kompaz.win/2017/07/05/（转）玩转Linux防火墙命令iptables/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>玩转Linux防火墙命令iptables[转] | Kompass</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kompass</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Startseite</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archiv</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.kompaz.win/2017/07/05/（转）玩转Linux防火墙命令iptables/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Icean L">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kompass">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">玩转Linux防火墙命令iptables[转]
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Post created: 2017-07-05 16:29:00" itemprop="dateCreated datePublished" datetime="2017-07-05T16:29:00+08:00">2017-07-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Updated at: 2018-05-08 09:52:32" itemprop="dateModified" datetime="2018-05-08T09:52:32+08:00">2018-05-08</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/技术/" itemprop="url" rel="index"><span itemprop="name">技术</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
              <div class="post-description">Linux的使用者中有很多人还无法纯熟的玩转iptables.网络不通,常会怀疑防火墙，但不能精确的诊断.给出依据.本文总结下iptables，整理下自己的思路.</div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文转载自 <a href="http://fishcried.com/2016-02-19/iptables/" target="_blank" rel="noopener">http://fishcried.com/2016-02-19/iptables/</a></p>
<p>Linux的使用者中有很多人还无法纯熟的玩转iptables.网络不通,常会怀疑防火墙，但不能精确的诊断.给出依据.本文总结下iptables，整理下自己的思路.</p>
<blockquote>
<p>讲个经历: 一次网络延迟问题诊断时，进行了很久也无法找到根源，一位其他组同事告诉我说把iptables服务关闭了，因为在之前的公司曾经遇到过类似问题。当时就凌乱了，iptables规则排查过，没有规则，默认ACCEPT。而且把iptables服务关闭是什么意思(我用的是ubuntu)？，我就说iptables不是服务，没法关闭啊，除非把内核模块卸载了，但是卸载了怕出现其他问题（线上环境），然后我又把iptables只是个命令，netfilter框架是什么给讲了一遍。同事说，这个具体的不懂，但是centos上是可以关闭的，问题解决后，我装了一台centos机器，还真有<code>service iptables stop</code>命令，实际上就是卸载相关的模块.</p>
</blockquote>
<blockquote>
<blockquote>
<p>原来只是大家的理解角度不同而已.</p>
</blockquote>
</blockquote>
<p>看下常用的一张图，来说明下iptables的构成.</p>
<p><img src="http://fishcried.com/img/netfilter_iptables.png" alt="netfilter与iptables的关系"></p>
<ul>
<li>iptables其实是个client，供用户去管理防火墙.相关的请求最后会发送相关内核模块，如ip_tables.</li>
<li>ip_tables内核模块主要用于组织iptables使用的表,链,规则.</li>
<li>netfilter是一套技术框架，ip_tables依托于netfilter来注册各种hooks实现对数据包的具体控制.一些厂商的防火墙，入侵检测，入侵防御系统什么的基本依托于Netfilter来实现(从事过相关开发).</li>
</ul>
<p>看了上面的图，也就明白了为什么有人叫Linux的防火墙为”iptables”,有的叫”netfilter/iptebles”,有的干脆叫”netfilter”了.角度不同而已.</p>
<a id="more"></a>
<h3 id="Linux防火墙原理"><a href="#Linux防火墙原理" class="headerlink" title="Linux防火墙原理"></a>Linux防火墙原理</h3><p>想玩转很复杂的命令，用得多了自然就记住了，但只能说是能玩，还不能说是玩转。能玩转，必然是对后面的原理理解得非常透彻. 比如说:</p>
<ol>
<li><code>ps,top,lsof</code>这些命令，如果不理解进程的构成(资源),不理解进程调度，想深刻的理解命令输出的含义，灵活的运用命令是很难的.使用<code>strace</code>可能就更费力了。</li>
<li>同样<code>tcpdump,ip,ethtool，ss</code>命令，在对TCP/IP相关协议不清楚的情况下，不清楚各个协议字段的情况下想玩转也很困难,只能常常叹参数复杂.</li>
</ol>
<p>那么,一起来学习下防火墙背后的原理吧.</p>
<h4 id="Netfilter框架"><a href="#Netfilter框架" class="headerlink" title="Netfilter框架"></a>Netfilter框架</h4><p><strong>Netfilter的Hook点</strong></p>
<p><img src="http://fishcried.com/img/netfilter_arch.png" alt="netfilter包处理"></p>
<p>Netifilter框架其实非常简单，在数据包处理的不同阶段提供了5大HOOK点，可以在这5个地方注册自己的功能函数，从而对数据包进行控制。</p>
<p>数据包从左边进入IP协议栈，进行IP校验以后，数据包被第一个钩子函数PRE_ROUTING处理，然后就进入路由模块，由其决定该数据包是转发出去还是送给本机。若该数据包是送给本机的，则要经过钩子函数LOCAL_IN处理后传递给本机的上层协议；若该数据包应该被转发，则它将被钩子函数FORWARD处理，然后还要经钩子函数POST_ROUTING处理后才能传输到网络。本机进程产生的数据包要先经过钩子函数LOCAL_OUT处理后，再进行路由选择处理，然后经过钩子函数POST_ROUTING处理后再发送到网络。</p>
<h4 id="iptables原理"><a href="#iptables原理" class="headerlink" title="iptables原理"></a>iptables原理</h4><p>已经知道iptables背后的实现是基于netfilter框架,通过在不同的hook点按照优先级插入功能函数来控制数据包.iptables以表-&gt;链-&gt;规则的逻辑来对流量的逻辑控制.</p>
<p>iptables根据功能定义了4个表,raw,mangle,filter,nat。这个四个表中有各自包含不同的链，如PREROUTING,INPUT,FORWARD,OUTPUT,POSTROUTING,这些链与Netfilter的HOOK点相对应，链中包含具体的规则从而控制数据包了. 重复一下，之所以区分出来4个不同的表，就是为了进行功能划分，不同的表对用不同的功能。</p>
<p><img src="http://fishcried.com/img/iptables_netfilter.png" alt="img"></p>
<p>图中上部分为表与链的对应.下部分则是iptables与netfilter的结合，仔细看图可以梳理出数据包的整个匹配过程.</p>
<p><strong>Filter表</strong></p>
<p>filter表用于实现对转发包的控制.表中的三个链INPUT,FORWARD,OUTPUT分别处理对应类型的数据包.通过在对应的链上设置规则最终对数据包进行控制.通俗的讲,INPUT用户保护本机,OUTPUT用户限制本机应用程序的网络访问,FORWARD链一般用于保护后端的服务器.</p>
<ul>
<li>INPUT 进入本机进程的数据包</li>
<li>FORWARD 主机扮演的是路由的角色,经由本机的数据包</li>
<li>OUTPUT 本机进程生成数据包</li>
</ul>
<p><strong>NAT表</strong></p>
<p>NAT(Network Address Traslation),网络地址转换.包含了PREROUTING,OUTPUT,POSTROUTING链.</p>
<ul>
<li>PREROUTING 在路由之前先修改目的ip,实现DNAT</li>
<li>OUTPUT 用于解决本机发送的数据包实现DNAT功能.因为本机发送的数据包会经由OUTPUT,POSTROUTING, POSTROUTING只能做SNAT,所以设计了OUTPUT来处理本机发送数据的DNAT,因为如果本机发出的数据包无法经过PREROUTING,没法做DNAT).</li>
<li>POSTROUTING 数据包离开时经由POSTROUTING,用户修改源地址,实现SNAT.</li>
</ul>
<p><strong>Mangle表</strong></p>
<p>用来修改数据包.没怎么用过.一般用于QOS.</p>
<p><strong>Raw表</strong></p>
<p>用来进行连接跟踪设置.可以用于加速规则匹配.</p>
<h3 id="防火墙相关命令的使用"><a href="#防火墙相关命令的使用" class="headerlink" title="防火墙相关命令的使用"></a>防火墙相关命令的使用</h3><p><strong>iptables</strong></p>
<p>如果非必要,真没有人愿意去详细的学习iptables语法,写起来太麻烦.但熟悉熟悉，理解了原理,掌握起来也很容易.任何命令的参数其实都有其自己的体系，遵循着背后的原理.</p>
<p>iptables使用的语法: <code>iptables [-t table] 操作 chain RULE</code>,下面是一个简化图.</p>
<p><img src="http://fishcried.com/img/iptables_usage.png" alt="iptables的使用"></p>
<ol>
<li>如果想查看特别的表时使用<code>-t</code>指定,如果查看单独的链需要在操作后面指定.</li>
<li>如果是查看规则定义,使用<code>-S</code>. <code>-S</code>比<code>-L</code>查看规则时更加清晰.</li>
<li>如果查看匹配状况使用<code>-nvL</code>.配合watch使用.</li>
<li><code>--line-number</code>用于查看规则号.</li>
</ol>
<p><strong>iptables-save</strong></p>
<p>这个命令主要是把内存态的规则保存到文件,然后下次启动的时候用<code>iptables-restore</code>来载入规则. 但是这个命令常常用来查看防火墙规则.比<code>iptables</code>用得都多, 主要是输出结果的格式比较紧凑直观.而且能方便的能看到所有表的规则.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">┌─[ubuntu@fishcried] - [~] - [2015-07-17 05:47:22]</span><br><span class="line">└─[0] sudo iptables-save</span><br><span class="line"># Generated by iptables-save v1.4.21 on Fri Jul 17 17:46:45 2015</span><br><span class="line">*mangle</span><br><span class="line">:PREROUTING ACCEPT [170491:25205613]</span><br><span class="line">:INPUT ACCEPT [170491:25205613]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [186436:72064133]</span><br><span class="line">:POSTROUTING ACCEPT [186436:72064133]</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jul 17 17:46:45 2015</span><br><span class="line"># Generated by iptables-save v1.4.21 on Fri Jul 17 17:46:45 2015</span><br><span class="line">*nat</span><br><span class="line">:PREROUTING ACCEPT [726722:43601168]</span><br><span class="line">:INPUT ACCEPT [726722:43601168]</span><br><span class="line">:OUTPUT ACCEPT [17016:1033385]</span><br><span class="line">:POSTROUTING ACCEPT [17016:1033385]</span><br><span class="line">:DOCKER - [0:0]</span><br><span class="line">-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER</span><br><span class="line">-A POSTROUTING -s 172.17.0.0/16 ! -d 172.17.0.0/16 -j MASQUERADE</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jul 17 17:46:45 2015</span><br><span class="line"># Generated by iptables-save v1.4.21 on Fri Jul 17 17:46:45 2015</span><br><span class="line">*filter</span><br><span class="line">:INPUT ACCEPT [5130295:773100722]</span><br><span class="line">:FORWARD ACCEPT [0:0]</span><br><span class="line">:OUTPUT ACCEPT [5052679:681817970]</span><br><span class="line">-A FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 ! -o docker0 -j ACCEPT</span><br><span class="line">-A FORWARD -i docker0 -o docker0 -j ACCEPT</span><br><span class="line">COMMIT</span><br><span class="line"># Completed on Fri Jul 17 17:46:45 2015</span><br></pre></td></tr></table></figure>
<ul>
<li>输出是分段的,每个段落一个表,*开头后面跟着表名</li>
<li>:开头的行是对链匹配次数的总结,后面跟着统计信息,[数据包:字节数].</li>
<li>后面跟着的是具体规则</li>
<li>最后跟着<code>COMMIT</code>表示一个表的结束</li>
</ul>
<p><code>iptables-save</code>有两个选项:</p>
<ul>
<li>-t 后面可以指定表明</li>
<li>-c 输出会在每条规则前加上匹配信息</li>
</ul>
<p><strong>如何快速查看iptables的流量匹配?</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables [-t 表] -L [链] -nv</span><br><span class="line">iptables-save -c</span><br></pre></td></tr></table></figure>
<p>如果想快速的查看规则匹配情况,可以使用上面两条命令.第一条命令较为灵活,可以控制表和链,而且统计信息比较人性化.第二条命令简单. 配合watch能够动态观察.</p>
<p><strong>iptables自定义连</strong></p>
<p>如果想自行定义规则链,可以通过<code>-N</code>参数,然后通过<code>-j/--jump</code>跳转过来就可以了.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iptables -N 链名</span><br><span class="line">iptables ... -j 链名</span><br></pre></td></tr></table></figure>
<h3 id="iptables规则调优策略"><a href="#iptables规则调优策略" class="headerlink" title="iptables规则调优策略"></a>iptables规则调优策略</h3><p><strong>优化的核心原则就是减少规则匹配.</strong></p>
<ul>
<li>简化规则<ul>
<li>用<code>multiport</code>,<code>iprange</code>模块,简化规则数量,也减少了匹配次数.</li>
</ul>
</li>
<li>调整匹配顺序<ul>
<li>书写规则顺序的原则,通用匹配放在前面. 配合<code>iptable -t tname -Lnv</code>的观察数据</li>
<li>提前规则的在表的位置.例如将filter表中针对dnat后匹配的规则放到raw中匹配,需要使用没有做dnat的ip.这样减少了很多次匹配.</li>
<li>分层优化,减少匹配顺序.通过自定义的链,来跳转规则.这样就能减少匹配次数了</li>
</ul>
</li>
</ul>
<p><strong>NEW,ESTABLISHED,RELATED,INVALID状态</strong></p>
<ul>
<li>NEW: conntrack模块看到的某个连接第一个包，它即将被匹配了。比如，我们看到一个SYN包，是我们所留意的连接的第一个包，就要匹配它。第一个包也可能不是SYN包，但它仍会被认为是NEW状态。</li>
<li>ESTABLISHED: 已经注意到两个方向上的数据传输，而且会继续匹配这个连接的包。处于ESTABLISHED状态的连接是非常容易理解的。只要发送并接到应答，连接就是ESTABLISHED的了。一个连接要从NEW变为ESTABLISHED，只需要接到应答包即可，不管这个包是发往防火墙的，还是要由防火墙转发的。ICMP的错误和重定向等信息包也被看作是ESTABLISHED，只要它们是我们所发出的信息的应答。</li>
<li>RELATED 当一个连接和某个已处于ESTABLISHED状态的连接有关系时，就被认为是RELATED的了。换句话说，一个连接要想是RELATED的，首先要有一个ESTABLISHED的连接。这个ESTABLISHED连接再产生一个主连接之外的连接，这个新的连接就是RELATED的了，比如ftp的父子链接.</li>
<li>非以上状态的包.</li>
</ul>
<h3 id="一些实例"><a href="#一些实例" class="headerlink" title="一些实例"></a>一些实例</h3><p><strong>tcp通用规则</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 这条规则能够过滤掉很多类型的端口扫描</span><br><span class="line">iptables -t filter -A INPUT -p tcp  -m state --state INVALID -j DROP</span><br><span class="line"># 避免配置很多内部端口通行规则</span><br><span class="line">iptables -t filter -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure>
<p><strong>端口扫描</strong></p>
<p>state与recent模块配合使用.30分钟内发起22,21,80以外端口超过10次,认为是portscan.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p all -m state --state ESTABLISHED,RELATED -j ACCEPT</span><br><span class="line">iptables -A INPUT -p all -m state --state NEW -m recent --name port_scan --update --seconds 1800 --hitcount 10 -j DROP</span><br><span class="line">iptables -A INPUT -p tcp --syn -m state --state NEW -m multiport --dports 22,21,80 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p all -m recent --name port_scan --set</span><br></pre></td></tr></table></figure>
<p><strong>暴力猜解</strong></p>
<p>暴力猜解会发起很多次尝试,主要是在这里下手.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#pop3猜解</span><br><span class="line">iptables -A OUTPUT -p tcp --sport 110 -m string --algo bm --string &quot;-ERR Authentication failed.&quot; \</span><br><span class="line">                          -m recent --name pop3 \</span><br><span class="line">                          --update --seconds 600 --hicount 6 -j REJECT</span><br><span class="line">iptables -A OUTPUT -p tcp --sport 110 -m string --algo bm --string &quot;-ERR Authentication failed.&quot; \</span><br><span class="line">                          -m recent --name pop3 --set</span><br><span class="line"></span><br><span class="line">#ssh猜解</span><br><span class="line">  iptables -A INPUT -p tcp --syn --dport 22 -m recent --name ssh --update --seconds 600 --hitcount 4 -j DROP</span><br><span class="line">  iptables -A INPUT -p tcp --syn --dport 22 -m recent --name ssh --set</span><br></pre></td></tr></table></figure>
<p><strong>Syn flood</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">modprobe ipt_recent ip_list_tot=16384</span><br><span class="line">iptables -N SYN_FLOOD</span><br><span class="line">iptables -A FORWARD -p tcp --syn --dport 80 -m limit --limit 1/m --limit-burst 300 -j ACCEPT</span><br><span class="line">iptables -A FORWARD -p tcp --syn --dport 80 -j SYN_FLOOD</span><br><span class="line">iptables -A SYN_FLOOD -p tcp --syn --dport 80 -m recent --name syn_flood --update --second 123 --hitcount 1 -j ACCEPT</span><br><span class="line">iptables -A SYN_FLOOD -p tcp --syn --dport 80 -m recent --name syn_flood --set</span><br><span class="line">iptables -A SYN_FLOOD -p tcp --syn --dport 80 -j DROP</span><br></pre></td></tr></table></figure>
<p>也可以通过调整网络子系统的参数来抵御flood攻击:</p>
<ul>
<li>net.ipv4.tcp_synack_retries</li>
<li>net.ipv4.tcp_max_syn_backlog</li>
<li>net.ipv4.tcp_syncookies</li>
</ul>
<p><strong>ip欺骗经典配置</strong></p>
<ul>
<li>任何进入网络的数据包不能把网络内部的地址作为源地址。</li>
<li>任何进入网络的数据包必须把网络内部的地址作为目的地址。</li>
<li>任何离开网络的数据包必须把网络内部的地址作为源地址。</li>
<li>任何离开网络的数据包不能把网络内部的地址作为目的地址。</li>
<li>任何进入或离开网络的数据包不能把一个私有地址(Private Address)或在RFC1918中列出的属于保留空间(包括10.x.x.x/8、172.16.x.x/12 或192.168.x.x/16 和网络回送地址127.0.0.0/8.)的地址作为源或目的地址。</li>
<li>阻塞任意源路由包或任何设置了IP选项的包</li>
</ul>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iptables/" rel="tag"># iptables</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/05/OpenWRT 配置脚本总结/" rel="next" title="OpenWRT 配置脚本总结">
                <i class="fa fa-chevron-left"></i> OpenWRT 配置脚本总结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/06/OpenWRT 挂载网络驱动器/" rel="prev" title="OpenWRT 挂载网络驱动器">
                OpenWRT 挂载网络驱动器 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Icean L</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">77</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">Kategorien</span>
                  
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">33</span>
                    <span class="site-state-item-name">Tags</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Linux防火墙原理"><span class="nav-number">1.</span> <span class="nav-text">Linux防火墙原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Netfilter框架"><span class="nav-number">1.1.</span> <span class="nav-text">Netfilter框架</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#iptables原理"><span class="nav-number">1.2.</span> <span class="nav-text">iptables原理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#防火墙相关命令的使用"><span class="nav-number">2.</span> <span class="nav-text">防火墙相关命令的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#iptables规则调优策略"><span class="nav-number">3.</span> <span class="nav-text">iptables规则调优策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些实例"><span class="nav-number">4.</span> <span class="nav-text">一些实例</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Icean L</span>

  

  
</div>




  <div class="powered-by">Erstellt mit  <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.2.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
